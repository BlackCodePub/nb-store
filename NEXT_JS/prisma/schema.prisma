generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String                @id @default(cuid())
  email              String                @unique
  emailVerified      DateTime?
  name               String?
  image              String?
  phone              String?
  cpf                String?
  birthDate          DateTime?
  passwordHash       String?               @db.Text
  locale             String?               @default("pt-BR")
  currency           String?               @default("BRL")
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  accounts           Account[]
  sessions           Session[]
  orders             Order[]
  orderEvents        OrderEvent[]
  digitalEntitlements DigitalEntitlement[]
  downloadLogs       DigitalDownloadLog[]
  roles              UserRole[]
  cart               Cart?
  couponRedemptions  CouponRedemption[]
  comments           Comment[]
  dataExportRequests DataExportRequest[]
  addresses          UserAddress[]
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Order {
  id            String    @id @default(cuid())
  userId        String
  status        String
  paidAt        DateTime?
  fulfilledAt   DateTime?
  invoiceNumber String?
  subtotal      Float     @default(0)
  taxTotal      Float     @default(0)
  total         Float     @default(0)
  shippingTotal Float     @default(0)
  discountTotal Float     @default(0)
  couponCode    String?   // Cupom usado (se houver)
  fxRateUsed    Float?    // Taxa de câmbio no momento do pedido
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments      Payment[]
  items         OrderItem[]
  events        OrderEvent[]
  address       OrderAddress?
  shipments     OrderShipment[]
  couponRedemption CouponRedemption?
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  variantId String?
  quantity  Int      @default(1)
  price     Float
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
}

model Payment {
  id                String    @id @default(cuid())
  provider          String
  providerReference String    @unique
  status            String
  amount            Float?
  payloadJson       Json?
  orderId           String?
  order             Order?    @relation(fields: [orderId], references: [id])
  lastWebhookAt     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  webhooks          PaymentWebhookLog[]
}

model PaymentWebhookLog {
  id                String   @id @default(cuid())
  provider          String
  providerReference String
  status            String
  rawBody           String   @db.Text
  createdAt         DateTime @default(now())
  paymentId         String?
  payment           Payment? @relation(fields: [paymentId], references: [id])

  @@index([providerReference])
}

model DigitalAsset {
  id            String               @id @default(cuid())
  name          String
  type          String               @default("file") // file | link | license
  path          String?              // Para arquivos
  url           String?              // Para links externos
  licenseKey    String?              // Para licenças
  productId     String?
  variantId     String?
  maxDownloads  Int?
  expirationDays Int?
  product       Product?             @relation(fields: [productId], references: [id], onDelete: SetNull)
  variant       ProductVariant?      @relation(fields: [variantId], references: [id], onDelete: SetNull)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  entitlements  DigitalEntitlement[]

  @@index([productId])
  @@index([variantId])
}

model DigitalEntitlement {
  id             String               @id @default(cuid())
  userId         String
  assetId        String
  expiresAt      DateTime?
  downloadsCount Int                  @default(0)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  asset          DigitalAsset         @relation(fields: [assetId], references: [id], onDelete: Cascade)
  downloads      DigitalDownloadLog[]
}

model DigitalDownloadLog {
  id             String           @id @default(cuid())
  entitlementId  String
  userId         String
  ip             String
  userAgent      String
  signedUrl      String
  createdAt      DateTime         @default(now())
  entitlement    DigitalEntitlement @relation(fields: [entitlementId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entitlementId])
  @@index([userId])
}

// Catálogo
model Category {
  id              String           @id @default(cuid())
  name            String           // Nome padrão (pt-BR)
  nameEn          String?          // Nome em inglês
  slug            String           @unique
  description     String?          // Descrição padrão (pt-BR)
  descriptionEn   String?          // Descrição em inglês
  parentId        String?          // Categoria pai (hierarquia)
  parent          Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children        Category[]       @relation("CategoryHierarchy")
  products        Product[]
  couponCategories CouponCategory[]
  discordRules    DiscordRule[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([parentId])
}

model Product {
  id             String            @id @default(cuid())
  name           String            // Nome padrão (pt-BR)
  nameEn         String?           // Nome em inglês
  slug           String            @unique
  description    String?           // Descrição padrão (pt-BR)
  descriptionEn  String?           // Descrição em inglês
  price          Float
  currency       String            @default("BRL")
  active         Boolean           @default(true)
  type           String            @default("physical") // physical | digital
  // SEO
  metaTitle      String?           // Meta title para SEO
  metaDescription String?          // Meta description para SEO
  // Peso e dimensões (produtos físicos)
  weight         Float?            // Peso em gramas
  width          Float?            // Largura em cm
  height         Float?            // Altura em cm
  depth          Float?            // Profundidade em cm
  categoryId     String?
  category       Category?         @relation(fields: [categoryId], references: [id])
  variants       ProductVariant[]
  images         ProductImage[]
  orderItems     OrderItem[]
  cartItems      CartItem[]
  couponProducts CouponProduct[]
  discordRules   DiscordRule[]
  digitalAssets  DigitalAsset[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
}

model ProductVariant {
  id            String          @id @default(cuid())
  productId     String
  name          String
  sku           String          @unique
  price         Float?
  stock         Int             @default(0)
  active        Boolean         @default(true) // Status ativo/inativo
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  images        ProductImage[]
  orderItems    OrderItem[]
  cartItems     CartItem[]
  digitalAssets DigitalAsset[]
}

model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  userId    String?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([orderId])
}

model ProductImage {
  id         String    @id @default(cuid())
  productId  String
  variantId  String?
  url        String
  position   Int       @default(0)
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant    ProductVariant? @relation(fields: [variantId], references: [id])
}

// RBAC
model Role {
  id          String          @id @default(cuid())
  name        String          @unique
  level       Int             @default(100) // menor = mais privilégio
  isAdmin     Boolean         @default(false)
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model Permission {
  id          String            @id @default(cuid())
  key         String            @unique
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId String
  roleId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

// ==========================================
// Carrinho
// ==========================================

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id                    String          @id @default(cuid())
  cartId                String
  productId             String
  variantId             String?
  quantity              Int             @default(1)
  unitPriceSnapshot     Float           // Preço no momento de adicionar
  nameSnapshot          String          // Nome do produto/variante
  cart                  Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product               Product         @relation(fields: [productId], references: [id])
  variant               ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, productId, variantId])
}

// ==========================================
// Cupons
// ==========================================

model Coupon {
  id                String            @id @default(cuid())
  code              String            @unique
  type              String            // percent | fixed
  value             Int               // percent: 1-100, fixed: cents
  startsAt          DateTime?
  endsAt            DateTime?
  maxUsesTotal      Int?
  maxUsesPerUser    Int?
  minSubtotalCents  Int?
  isActive          Boolean           @default(true)
  products          CouponProduct[]
  categories        CouponCategory[]
  redemptions       CouponRedemption[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model CouponProduct {
  couponId  String
  productId String
  coupon    Coupon  @relation(fields: [couponId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([couponId, productId])
}

model CouponCategory {
  couponId   String
  categoryId String
  coupon     Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([couponId, categoryId])
}

model CouponRedemption {
  id        String   @id @default(cuid())
  couponId  String
  userId    String
  orderId   String?  @unique // Relação one-to-one com Order
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  order     Order?   @relation(fields: [orderId], references: [id])
  createdAt DateTime @default(now())

  @@index([couponId])
  @@index([userId])
}

// ==========================================
// Endereços do Usuário
// ==========================================

model UserAddress {
  id           String   @id @default(cuid())
  userId       String
  name         String
  phone        String?
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zipCode      String
  country      String   @default("BR")
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==========================================
// Endereços de Pedido
// ==========================================

model OrderAddress {
  id          String  @id @default(cuid())
  orderId     String  @unique
  type        String  @default("shipping") // shipping | billing
  name        String
  phone       String?
  street      String
  number      String
  complement  String?
  neighborhood String
  city        String
  state       String
  zipCode     String
  country     String  @default("BR")
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

// ==========================================
// Envio de Pedido (Frete)
// ==========================================

model OrderShipment {
  id            String    @id @default(cuid())
  orderId       String
  carrier       String    // correios, etc
  serviceCode   String    // PAC, SEDEX
  trackingCode  String?
  estimatedDays Int?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([orderId])
}

// ==========================================
// Discord Gating
// ==========================================

model DiscordRule {
  id          String   @id @default(cuid())
  productId   String?
  categoryId  String?
  guildId     String   // ID da guild/server Discord
  roleId      String?  // ID do role obrigatório (opcional)
  product     Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([productId])
  @@index([categoryId])
}

// ==========================================
// Blog
// ==========================================

model Post {
  id           String            @id @default(cuid())
  slug         String            @unique
  isPublished  Boolean           @default(false)
  publishedAt  DateTime?
  translations PostTranslation[]
  comments     Comment[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model PostTranslation {
  id          String  @id @default(cuid())
  postId      String
  locale      String  // pt-BR | en-US
  title       String
  content     String  @db.Text
  excerpt     String?
  seoTitle    String?
  seoDescription String?
  post        Post    @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, locale])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String   @db.Text
  status    String   @default("pending") // pending | approved | rejected
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([userId])
}

// ==========================================
// Taxa de Câmbio
// ==========================================

model ExchangeRate {
  id        String   @id @default(cuid())
  fromCurrency String
  toCurrency   String
  rate      Float
  fetchedAt DateTime @default(now())

  @@unique([fromCurrency, toCurrency, fetchedAt])
  @@index([fromCurrency, toCurrency])
}

// ==========================================
// LGPD
// ==========================================

model CookieConsent {
  id        String   @id @default(cuid())
  userId    String?
  sessionId String?
  ip        String
  userAgent String
  accepted  Boolean
  categories Json?   // { analytics: true, marketing: false }
  createdAt DateTime @default(now())

  @@index([userId])
}

model DataExportRequest {
  id          String    @id @default(cuid())
  userId      String
  status      String    @default("pending") // pending | processing | completed | failed
  fileUrl     String?
  completedAt DateTime?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())

  @@index([userId])
}

// ==========================================
// Banner/Slider
// ==========================================

model Banner {
  id          String    @id @default(cuid())
  title       String
  titleEn     String?
  subtitle    String?
  subtitleEn  String?
  imageUrl    String
  linkUrl     String?
  buttonText  String?
  buttonTextEn String?
  position    Int       @default(0)
  active      Boolean   @default(true)
  startsAt    DateTime?
  endsAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ==========================================
// Newsletter
// ==========================================

model NewsletterSubscription {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  active      Boolean  @default(true)
  confirmedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==========================================
// Templates de Email
// ==========================================

model EmailTemplate {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  audience  String?
  subject   String
  html      String   @db.Text
  text      String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// Configurações da Loja
// ==========================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
